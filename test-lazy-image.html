<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LazyImage Debug Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f9f9f9;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .image-container {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .spacer {
            height: 100vh;
            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <h1>LazyImage Component Debug Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Direct Image (No Lazy Loading)</h2>
        <div class="image-container">
            <img 
                src="/assets/05_traditional_heritage-1536w.webp"
                srcset="/assets/05_traditional_heritage-640w.webp 640w,
                        /assets/05_traditional_heritage-768w.webp 768w,
                        /assets/05_traditional_heritage-1024w.webp 1024w,
                        /assets/05_traditional_heritage-1536w.webp 1536w"
                sizes="100vw"
                alt="Traditional Japanese raisin tree harvesting"
                style="width: 100%; height: 100%; object-fit: cover; filter: brightness(0.85);"
                onload="console.log('‚úÖ Direct image loaded'); this.style.border = '3px solid green';"
                onerror="console.error('‚ùå Direct image failed'); this.style.border = '3px solid red';"
            />
        </div>
    </div>

    <div class="spacer">
        Scroll down to test lazy loading ‚¨áÔ∏è
    </div>

    <div class="test-section">
        <h2>Test 2: Original LazyImage Component</h2>
        <div id="original-lazy-image" class="image-container"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Fixed LazyImage Component</h2>
        <div id="fixed-lazy-image" class="image-container"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Original LazyImage Component (with issues)
        const LazyImage = ({ 
          src, 
          alt, 
          className = '',
          threshold = 0.1,
          rootMargin = '50px',
          placeholder = 'blur',
          ...props 
        }) => {
          const [isLoaded, setIsLoaded] = useState(false);
          const [isInView, setIsInView] = useState(false);
          const imgRef = useRef(null);

          useEffect(() => {
            const observer = new IntersectionObserver(
              ([entry]) => {
                if (entry.isIntersecting) {
                  setIsInView(true);
                  observer.unobserve(entry.target);
                }
              },
              { threshold, rootMargin }
            );

            if (imgRef.current) {
              observer.observe(imgRef.current);
            }

            return () => {
              if (imgRef.current) {
                observer.unobserve(imgRef.current);
              }
            };
          }, [threshold, rootMargin]);

          return React.createElement('div', {
            ref: imgRef,
            className: "relative w-full h-full",
            style: { 
              backgroundColor: isLoaded ? 'transparent' : '#f3f4f6',
              width: '100%',
              height: '100%'
            }
          }, 
            isInView && React.createElement('img', {
              src: src,
              alt: alt,
              className: `${className} transition-opacity duration-300 ${isLoaded ? 'opacity-100' : 'opacity-0'}`,
              onLoad: () => setIsLoaded(true),
              loading: "lazy",
              style: { width: '100%', height: '100%', objectFit: 'cover', filter: 'brightness(0.85)' },
              ...props
            })
          );
        };

        // Fixed LazyImage Component
        const LazyImageFixed = ({ 
          src, 
          alt, 
          className = '',
          threshold = 0.1,
          rootMargin = '50px',
          placeholder = 'blur',
          ...props 
        }) => {
          const [isLoaded, setIsLoaded] = useState(false);
          const [isInView, setIsInView] = useState(false);
          const [hasError, setHasError] = useState(false);
          const imgRef = useRef(null);
          const observerRef = useRef(null);

          useEffect(() => {
            const currentElement = imgRef.current;
            
            if (!currentElement) return;

            const observer = new IntersectionObserver(
              ([entry]) => {
                console.log('üîç Fixed Intersection Observer:', {
                  isIntersecting: entry.isIntersecting,
                  intersectionRatio: entry.intersectionRatio,
                  src: src
                });
                
                if (entry.isIntersecting) {
                  setIsInView(true);
                  observer.unobserve(entry.target);
                }
              },
              { threshold, rootMargin }
            );

            observerRef.current = observer;
            observer.observe(currentElement);

            return () => {
              if (observerRef.current && currentElement) {
                observerRef.current.unobserve(currentElement);
              }
            };
          }, [threshold, rootMargin, src]);

          const handleLoad = () => {
            console.log('‚úÖ Fixed image loaded successfully:', src);
            setIsLoaded(true);
            setHasError(false);
          };

          const handleError = (e) => {
            console.error('‚ùå Fixed image failed to load:', src, e);
            setHasError(true);
            setIsLoaded(false);
          };

          const showBackground = !isLoaded && !hasError;

          return React.createElement('div', {
            ref: imgRef,
            className: "relative w-full h-full",
            style: { 
              backgroundColor: showBackground ? '#f3f4f6' : 'transparent',
              minHeight: '200px',
              width: '100%',
              height: '100%'
            }
          }, [
            // Debug info
            React.createElement('div', {
              key: 'debug',
              className: "absolute top-2 left-2 bg-black bg-opacity-75 text-white text-xs p-1 rounded z-10",
              style: {
                position: 'absolute',
                top: '8px',
                left: '8px',
                background: 'rgba(0,0,0,0.75)',
                color: 'white',
                fontSize: '12px',
                padding: '4px',
                borderRadius: '4px',
                zIndex: 10
              }
            }, `InView: ${isInView ? '‚úÖ' : '‚ùå'} | Loaded: ${isLoaded ? '‚úÖ' : '‚ùå'} | Error: ${hasError ? '‚ùå' : '‚úÖ'}`),

            // Image
            isInView && React.createElement('img', {
              key: 'image',
              src: src,
              alt: alt,
              className: `${className} transition-opacity duration-300 ${isLoaded ? 'opacity-100' : 'opacity-0'}`,
              onLoad: handleLoad,
              onError: handleError,
              style: { width: '100%', height: '100%', objectFit: 'cover', filter: 'brightness(0.85)' },
              ...props
            }),

            // Error state
            hasError && React.createElement('div', {
              key: 'error',
              className: "absolute inset-0 flex items-center justify-center bg-gray-200 text-gray-600",
              style: {
                position: 'absolute',
                inset: '0',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                background: '#e5e7eb',
                color: '#6b7280'
              }
            }, React.createElement('div', {
              style: { textAlign: 'center' }
            }, [
              React.createElement('div', { key: 'icon', style: { fontSize: '24px', marginBottom: '8px' } }, 'üì∑'),
              React.createElement('div', { key: 'msg', style: { fontSize: '14px' } }, 'Image failed to load'),
              React.createElement('div', { key: 'src', style: { fontSize: '12px', marginTop: '4px', opacity: 0.75 } }, src)
            ]))
          ]);
        };

        // Render components
        const originalContainer = document.getElementById('original-lazy-image');
        const fixedContainer = document.getElementById('fixed-lazy-image');

        ReactDOM.render(
          React.createElement(LazyImage, {
            src: "/assets/05_traditional_heritage-1536w.webp",
            srcSet: "/assets/05_traditional_heritage-640w.webp 640w, /assets/05_traditional_heritage-768w.webp 768w, /assets/05_traditional_heritage-1024w.webp 1024w, /assets/05_traditional_heritage-1536w.webp 1536w",
            sizes: "100vw",
            alt: "Traditional Japanese raisin tree harvesting",
            threshold: 0.1,
            rootMargin: "100px"
          }),
          originalContainer
        );

        ReactDOM.render(
          React.createElement(LazyImageFixed, {
            src: "/assets/05_traditional_heritage-1536w.webp",
            srcSet: "/assets/05_traditional_heritage-640w.webp 640w, /assets/05_traditional_heritage-768w.webp 768w, /assets/05_traditional_heritage-1024w.webp 1024w, /assets/05_traditional_heritage-1536w.webp 1536w",
            sizes: "100vw",
            alt: "Traditional Japanese raisin tree harvesting",
            threshold: 0.1,
            rootMargin: "100px"
          }),
          fixedContainer
        );
    </script>
</body>
</html>